# Endpoint Request Counting Recording Rules
# ==========================================
# 5분 간격으로 요청 수 증가량을 미리 계산하여 저장합니다.
# 저장된 값은 고정되므로, sum_over_time()으로 합산하면
# 조회 시점에 관계없이 동일한 일별/주별/월별 카운트를 얻을 수 있습니다.

groups:
  - name: endpoint_request_counting
    interval: 5m
    rules:
      # 서비스별 요청 수 증가량 (상태코드, HTTP 메소드 포함)
      - record: traefik:service_requests:increase5m
        expr: sum by (service, code, method) (increase(traefik_service_requests_total[5m]))

      # 서비스별 전체 요청 수 (집계용)
      - record: traefik:service_requests_total:increase5m
        expr: sum by (service) (increase(traefik_service_requests_total[5m]))

      # 라우터(엔드포인트)별 요청 수 증가량 (상태코드, HTTP 메소드 포함)
      - record: traefik:router_requests:increase5m
        expr: sum by (router, code, method) (increase(traefik_router_requests_total[5m]))

      # 라우터별 전체 요청 수 (집계용)
      - record: traefik:router_requests_total:increase5m
        expr: sum by (router) (increase(traefik_router_requests_total[5m]))
